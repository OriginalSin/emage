define(["require","qpf","qtek"],function(e){var t=e("qpf"),n=e("qtek"),r=n["2d"],i=t.use("components/meta/meta"),s=t.use("knockout"),o=i.derive(function(){return{stage:null,scene:null,paths:{r:null,g:null,b:null},resizeCanvas:null,resizeContext:null,size:64,sample:4}},{type:"HISTOGRAM",css:"histogram",initialize:function(){this.stage=new r.Renderer,this.scene=new r.Scene,this.paths.r=new r.renderable.Path({stroke:!1,style:new r.Style({fill:"red",globalAlpha:.5,shadow:"0 -2 3 black"})}),this.paths.g=new r.renderable.Path({stroke:!1,style:new r.Style({fill:"green",globalAlpha:.5})}),this.paths.b=new r.renderable.Path({stroke:!1,style:new r.Style({fill:"blue",globalAlpha:.5})}),this.scene.add(this.paths.r),this.scene.add(this.paths.g),this.scene.add(this.paths.b);var e=document.createElement("canvas");e.width=this.size,e.height=this.size,this.resizeCanvas=e,this.resizeContext=e.getContext("2d")},template:"",setImage:function(e){this.resizeContext.drawImage(e,0,0,this.size,this.size),this.refresh()},refresh:function(){var e=this.computeHistogram();e.r=this.normalizeHistogram(e.r),e.g=this.normalizeHistogram(e.g),e.b=this.normalizeHistogram(e.b),this.updatePath("r",e.r),this.updatePath("g",e.g),this.updatePath("b",e.b),this.stage.render(this.scene)},initPath:function(e){var t=this.paths[e],n=this.height(),r=this.width()/255*this.sample;t.segments=[{point:[0,n]}];var i=0;for(var s=0;s<256;s+=this.sample)t.segments.push({point:[i,0]}),i+=r;t.pushPoints([[this.width(),n],[0,n]])},updatePath:function(e,t){var n=this.paths[e],r=this.height();for(var i=this.sample;i<257;i+=this.sample)n.segments[i/this.sample-1].point[1]=(1-t[i-1]*2/3)*r},computeHistogram:function(){var e=this.resizeContext.getImageData(0,0,this.size,this.size),t=e.data,n={r:[],g:[],b:[]};for(var r=0;r<256;r++)n.r[r]=0,n.g[r]=0,n.b[r]=0;for(var r=0;r<this.size*this.size;r+=4){var i=t[r],s=t[r+1],o=t[r+2];n.r[i]++,n.g[s]++,n.b[o]++}return n},normalizeHistogram:function(e){var t=Math.max.apply(Math,e),n=[];for(var r=0;r<e.length;r++)n.push(e[r]/t);return n},afterRender:function(){this.$el[0].appendChild(this.stage.canvas)},afterResize:function(){this.stage.resize(this.width(),this.height()),this.initPath("r"),this.initPath("g"),this.initPath("b"),this.refresh()}});return i.provideBinding("histogram",o),o});