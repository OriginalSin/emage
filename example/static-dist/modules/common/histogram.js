define(["require","qpf","emage","knockout"],function(e){var t=e("qpf"),n=e("emage"),r=e("knockout"),i=n.qtek["2d"],s=t.use("components/meta/meta"),o=s.derive(function(){return{image:null,_stage:new i.Renderer,_scene:new i.Scene,_paths:{red:new i.renderable.Path({stroke:!0,style:new i.Style({fill:"red",stroke:"#950000",globalAlpha:.4,shadow:"0 -2 1 #555"})}),green:new i.renderable.Path({stroke:!0,style:new i.Style({fill:"green",stroke:"#009500",globalAlpha:.4,shadow:"0 -2 1 #555"})}),blue:new i.renderable.Path({stroke:!0,style:new i.Style({fill:"blue",stroke:"#000095",globalAlpha:.4,shadow:"0 -2 1 #555"})})},size:128,sample:r.observable(2),_histogram:new n.Histogram}},{type:"HISTOGRAM",css:"histogram",initialize:function(){this._scene.add(this._paths.red),this._scene.add(this._paths.green),this._scene.add(this._paths.blue),this._histogram.downSample=1/8},template:"",update:function(){if(!this.image)return;this._histogram.image=this.image,this._histogram.update()},refresh:function(){if(!this.image)return;histogramArray=this.getNormalizedHistogram(),this.updatePath("red",histogramArray.red),this.updatePath("green",histogramArray.green),this.updatePath("blue",histogramArray.blue),this._stage.render(this._scene)},initPath:function(e){var t=this._paths[e],n=this.height(),r=this.sample(),i=this.$el.width()/256*r;t.segments=[{point:[0,n]}];var s=0;for(var o=0;o<256;o+=r)t.segments.push({point:[s,0]}),s+=i;t.pushPoints([[this.$el.width(),n],[0,n]])},updatePath:function(e,t){var n=this._paths[e],r=this.height(),i=this.sample();for(var s=i;s<257;s+=i)n.segments[s/i].point[1]=(1-t[s-1])*r},getNormalizedHistogram:function(){function e(e){var t=0,n=[];for(var r=0;r<e.length;r++)e[r]>t&&(t=e[r]);for(var r=0;r<e.length;r++)n.push(t==0||isNaN(t)?0:e[r]/t);return n}var t=this._histogram.channels;return{red:e(t.red),green:e(t.green),blue:e(t.blue)}},afterRender:function(){this.$el[0].appendChild(this._stage.canvas)},afterResize:function(){this._stage&&this._stage.resize(this.$el.width(),this.$el.height()),this.initPath("red"),this.initPath("green"),this.initPath("blue"),this.refresh()}});return s.provideBinding("histogram",o),o});