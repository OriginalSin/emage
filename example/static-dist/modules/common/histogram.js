define(["require","qpf","emage","knockout"],function(e){var t=e("qpf"),n=e("emage"),r=e("knockout"),i=n.qtek["2d"],s=n.qtek.core.Vector2,o=t.use("meta/meta"),u=o.derive(function(){return{image:null,_layer:new i.Layer({enablePicking:!1}),_paths:{red:new i.shape.Path({stroke:!1,style:new i.Style({fill:"red",globalAlpha:.4,shadow:"0 -2 2 #333"})}),green:new i.shape.Path({stroke:!1,style:new i.Style({fill:"green",globalAlpha:.4,shadow:"0 -2 2 #333"})}),blue:new i.shape.Path({stroke:!1,style:new i.Style({fill:"blue",globalAlpha:.4,shadow:"0 -2 2 #333"})}),redStroke:new i.shape.Path({fill:!1,style:new i.Style({stroke:"#950000",globalAlpha:.7})}),greenStroke:new i.shape.Path({fill:!1,style:new i.Style({stroke:"#009500",globalAlpha:.7})}),blueStroke:new i.shape.Path({fill:!1,style:new i.Style({stroke:"#000095",globalAlpha:.7})})},size:128,sample:r.observable(2),_histogram:new n.Histogram}},{type:"HISTOGRAM",css:"histogram",initialize:function(){this._layer.add(this._paths.red),this._layer.add(this._paths.green),this._layer.add(this._paths.blue),this._layer.add(this._paths.redStroke),this._layer.add(this._paths.greenStroke),this._layer.add(this._paths.blueStroke),this._histogram.downSample=1/8},template:"",update:function(){if(!this.image)return;this._histogram.image=this.image,this._histogram.update()},refresh:function(){if(!this.image)return;histogramArray=this.getNormalizedHistogram(),this.updatePath("red",histogramArray.red),this.updatePath("green",histogramArray.green),this.updatePath("blue",histogramArray.blue),this._layer.render()},initPath:function(e){var t=this._paths[e],n=this.height(),r=this.sample(),i=this.$el.width()/256*r;t.segments=[{point:new s(0,n)}];var o=0;for(var u=0;u<256;u+=r)t.segments.push({point:new s(o,0)}),o+=i;t.pushPoints([new s(this.$el.width(),n),new s(0,n)]),this._paths[e+"Stroke"].segments=t.segments},updatePath:function(e,t){var n=this._paths[e],r=this.height(),i=this.sample();for(var s=i;s<257;s+=i)n.segments[s/i].point.y=(1-t[s-1])*r},getNormalizedHistogram:function(){function e(e){var t=[];for(var n=0;n<e.length;n++)t.push(e[n]/256);return t}var t=this._histogram.channels;return{red:e(t.red),green:e(t.green),blue:e(t.blue)}},afterRender:function(){this.$el[0].appendChild(this._layer.canvas)},onResize:function(){this._layer&&this._layer.resize(this.$el.width(),this.$el.height()),this.initPath("red"),this.initPath("green"),this.initPath("blue"),this.refresh()}});return o.provideBinding("histogram",u),u});