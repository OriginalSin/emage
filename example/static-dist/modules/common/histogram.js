define(["require","qpf","emage","knockout"],function(e){var t=e("qpf"),n=e("emage"),r=e("knockout"),i=n.qtek["2d"],s=t.use("components/meta/meta"),o=s.derive(function(){return{image:null,_stage:new i.Renderer,_scene:new i.Scene,_paths:{red:new i.renderable.Path({stroke:!1,style:new i.Style({fill:"red",globalAlpha:.4,shadow:"0 -2 2 #333"})}),green:new i.renderable.Path({stroke:!1,style:new i.Style({fill:"green",globalAlpha:.4,shadow:"0 -2 2 #333"})}),blue:new i.renderable.Path({stroke:!1,style:new i.Style({fill:"blue",globalAlpha:.4,shadow:"0 -2 2 #333"})}),redStroke:new i.renderable.Path({fill:!1,style:new i.Style({stroke:"#950000",globalAlpha:.7})}),greenStroke:new i.renderable.Path({fill:!1,style:new i.Style({stroke:"#009500",globalAlpha:.7})}),blueStroke:new i.renderable.Path({fill:!1,style:new i.Style({stroke:"#000095",globalAlpha:.7})})},size:128,sample:r.observable(2),_histogram:new n.Histogram}},{type:"HISTOGRAM",css:"histogram",initialize:function(){this._scene.add(this._paths.red),this._scene.add(this._paths.green),this._scene.add(this._paths.blue),this._scene.add(this._paths.redStroke),this._scene.add(this._paths.greenStroke),this._scene.add(this._paths.blueStroke),this._histogram.downSample=1/8},template:"",update:function(){if(!this.image)return;this._histogram.image=this.image,this._histogram.update()},refresh:function(){if(!this.image)return;histogramArray=this.getNormalizedHistogram(),this.updatePath("red",histogramArray.red),this.updatePath("green",histogramArray.green),this.updatePath("blue",histogramArray.blue),this._stage.render(this._scene)},initPath:function(e){var t=this._paths[e],n=this.height(),r=this.sample(),i=this.$el.width()/256*r;t.segments=[{point:[0,n]}];var s=0;for(var o=0;o<256;o+=r)t.segments.push({point:[s,0]}),s+=i;t.pushPoints([[this.$el.width(),n],[0,n]]),this._paths[e+"Stroke"].segments=t.segments},updatePath:function(e,t){var n=this._paths[e],r=this.height(),i=this.sample();for(var s=i;s<257;s+=i)n.segments[s/i].point[1]=(1-t[s-1])*r;n.smooth(1)},getNormalizedHistogram:function(){function e(e){var t=[];for(var n=0;n<e.length;n++)t.push(e[n]/256);return t}var t=this._histogram.channels;return{red:e(t.red),green:e(t.green),blue:e(t.blue)}},afterRender:function(){this.$el[0].appendChild(this._stage.canvas)},afterResize:function(){this._stage&&this._stage.resize(this.$el.width(),this.$el.height()),this.initPath("red"),this.initPath("green"),this.initPath("blue"),this.refresh()}});return s.provideBinding("histogram",o),o});