define(["require","../module","text!./viewport.xml","./viewport","qpf","knockout","$","emage","_"],function(e){function c(e){e.stopPropagation(),e.preventDefault();var t=e.dataTransfer.files[0];t&&t.type.match(/image/)&&h(t)}function h(e){l.onload=function(e){var t=new Image;l.onload=null,t.onload=function(){t.onload=null,f.setImage(t),f.mainComponent.$el.find(".draghint").remove()},t.src=e.target.result},l.readAsDataURL(e)}var t=e("../module"),n=e("text!./viewport.xml"),r=e("./viewport"),i=e("qpf"),s=e("knockout"),o=e("$"),u=e("emage"),a=e("_"),f=new t({name:"viewport",xml:n,applyFilter:s.observable(!0),resize:function(){if(f.mainComponent&&f.mainComponent.parent&&this.processor.image){var e=this.processor.image,t=e.height/e.width,n=f.mainComponent,r=n.parent.width(),i=n.parent.height();t<1?(n.$el.css({"margin-top":(i-r*t)/2+"px","margin-left":"0px"}),n.height(r*t),n.width(r)):(n.$el.css({"margin-left":(r-i/t)/2,"margin-top":"0px"}),n.width(i/t),n.height(i))}},onResize:function(){f.resize()},setImage:function(e){this.processor.image=e,this.update(),this.resize()},update:a.throttle(function(){f.processor.image&&(f.processor.update(),this.trigger("update"))},100),processor:new u.Processor,loadImageFromFile:h,colorAdjustLayer:null,hueLayer:null,filterLayer:null});f.on("start",function(){f.mainComponent.$el.find("canvas").replaceWith(this.processor.canvas);var e=new u.Layer;f.processor.add(e);var t=new u.Layer("buildin.coloradjust"),n=new u.Layer("buildin.hue");f.processor.add(t),f.processor.add(n),this.colorAdjustLayer=t,this.filterLayer=e,this.hueLayer=n;var r=new Image;r.onload=function(){f.setImage(r)},r.src="../file_upload/1.jpg"}),document.body.addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault()},!1),document.body.addEventListener("drop",c,!1);var l=new FileReader;return f});