define(["require","qpf","./pass"],function(e){var t=e("qpf"),n=t.use("core/clazz"),r=t.use("knockout"),i=t.use("ko.mapping"),s=e("./pass"),o=n.derive(function(){return{_passes:r.observableArray(),parameters:r.observableArray()}},function(){this.passes=i.fromJS(this.passes),_.each(this.passes&&this.passes(),function(e){var t=new s({fragmentShader:e.shaderString(),inputPin:{texture:null},parameters:{imageWidth:{type:"f",value:1024},imageHeight:{type:"f",value:1024}}}),n=e&&e.uniforms;_.each(n,function(e,n){var i={},s=r.utils.unwrapObservable(e.value);if(typeof s=="string"){var o=s.match(/(\S*)\((.*)\)/);if(o){var a=o[1],f=o[2].replace("\n","").split(/\s*,\s*/),l=u[a];l&&(s=l.apply(u,f))}}i[n]={value:s,type:e.type&&e.type()},t.addParameter(i),e.value.subscribe(function(e){t.updateParameter(n,e)}),this.parameters.push(e)},this),this._passes.push(t)},this),this.provides=r.computed(function(){var e=[];return _.each(this.parameters(),function(t){if(!t.ui)return;var n=_.omit(t,"ui","type");_.extend(n,{type:t.ui}),e.push(n)}),e},this)},{eachPass:function(e){_.each(this._passes(),function(t){e&&e(t)})},dispose:function(){}}),u={mat4:function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v){return _.each(arguments,function(e,t){arguments[t]=parseInt(e)}),new THREE.Matrix4(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v)},mat3:function(e,t,n,r,i,s,o,u,a){return _.each(arguments,function(e,t){arguments[t]=parseInt(e)}),new THREE.Matrix3(e,t,n,r,i,s,o,u,a)},texture:function(e){var t=THREE.ImageUtils.loadTexture("fx/"+e);return t.magFilter=THREE.NearestFilter,t.minFilter=THREE.NearestFilter,t.flipY=!1,t.needsUpdate=!0,t}};return o});